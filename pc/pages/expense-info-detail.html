<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>费用信息</title>
    <link rel="stylesheet" type="text/css" href="../lib/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="../css/base.css">
</head>

<body>
    <div class="panel panel-padding">
        <form id="detail" class="layui-form" action="" method="post">
            <div class="layui-form-item">
                <div class="layui-inline visible invisible-create">
                    <label class="layui-form-label"><span class="required">*</span>费用单据号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="expense_no" placeholder="请输入费用单据号" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label"><span class="required">*</span>客户号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="mchnt_id" lay-verify="required" placeholder="请输入客户号" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label"><span class="required">*</span>费用类型</label>
                    <div class="layui-input-inline">
                        <select name="expense_type" id="expense-type">
                            <option value=""></option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label"><span class="required">*</span>金额</label>
                    <div class="layui-input-inline">
                        <input type="text" name="amount" lay-verify="required" placeholder="请输入金额" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label"><span class="required">*</span>收费周期</label>
                    <div class="layui-input-inline">
                        <select name="expense_cycle" id="expense-cycle">
                            <option value=""></option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label"><span class="required">*</span>收费开始时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="start_date" lay-verify="required" placeholder="请输入收费开始时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">收费结束时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="end_date" placeholder="请输入收费结束时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">领用人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="recipient_by" placeholder="请输入领用人" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">发票号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="invoice_no" placeholder="请输入发票号" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">收款方式</label>
                    <div class="layui-input-inline">
                        <select name="receipt_type" id="receipt-type">
                            <option value=""></option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">收款日期</label>
                    <div class="layui-input-inline">
                        <input type="text" name="receipt_date" placeholder="请输入收款日期" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">收款备注</label>
                    <div class="layui-input-inline">
                        <input type="text" name="receipt_remark" placeholder="请输入收款备注" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">收款人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="receipt_by" placeholder="请输入收款人" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">收款时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="receipt_time" placeholder="请输入收款时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">作废备注</label>
                    <div class="layui-input-inline">
                        <input type="text" name="cancel_remark" placeholder="请输入作废备注" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">作废人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="cancel_by" placeholder="请输入作废人" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">作废时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="cancel_time" placeholder="请输入作废时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">退款方式</label>
                    <div class="layui-input-inline">
                        <select name="refund_type" id="refund-type">
                            <option value=""></option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">退款开户名称</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_account_name" placeholder="请输入退款开户名称" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">退款开户银行</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_account_bank" placeholder="请输入退款开户银行" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">退款开户支行</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_account_bank_branch_cd" placeholder="请输入退款开户支行" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">退款银行账号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_account_no" placeholder="请输入退款银行账号" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible">
                <div class="layui-inline">
                    <label class="layui-form-label">可退付日期</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_date" placeholder="请输入可退付日期" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">退款备注</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_remark" placeholder="请输入退款备注" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible visible-view">
                <div class="layui-inline">
                    <label class="layui-form-label">退款人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_by" placeholder="请输入退款人" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">退款时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="refund_time" placeholder="请输入退款时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible visible-view">
                <div class="layui-inline">
                    <label class="layui-form-label"><span class="required">*</span>打印标志</label>
                    <div class="layui-input-inline">
                        <input type="text" name="print_flag" lay-verify="required" placeholder="请输入打印标志" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">打印人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="print_by" placeholder="请输入打印人" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible visible-view">
                <div class="layui-inline">
                    <label class="layui-form-label">打印时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="print_time" placeholder="请输入打印时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">验证随机数</label>
                    <div class="layui-input-inline">
                        <input type="text" name="rand_num" placeholder="请输入验证随机数" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-inline">
                        <input type="text" name="remark" placeholder="请输入备注" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible visible-view">
                <div class="layui-inline">
                    <label class="layui-form-label">创建人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="created_by" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">创建时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="created_time" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible visible-view">
                <div class="layui-inline">
                    <label class="layui-form-label">最后修改人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="last_modified_by" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">最后修改时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="last_modified_time" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible visible-view">
                <div class="layui-inline">
                    <label class="layui-form-label">最后审核人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="last_checked_by" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">最后审核时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="last_checked_time" placeholder="" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item invisible visible-view">
                <label class="layui-form-label">审核备注</label>
                <div class="layui-input-block">
                    <input type="text" name="checked_reason" placeholder="" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn visible invisible-view" lay-submit="" lay-filter="detail">提交</button>
                    <button type="button" class="layui-btn layui-btn-primary" onclick="onClose()">关闭</button>
                </div>
            </div>
        </form>
    </div>
    <script id="upload-tpl" type="text/html">
        <div class="img-box"><img src="/p/action/uploads/" alt="..." class="img-thumbnail"></div>
    </script>
    <script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/layui/lay/dest/layui.all.js"></script>
    <script type="text/javascript" src="../lib/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript" src="../js/template.js"></script>
    <script type="text/javascript" src="../js/base.js"></script>
    <script type="text/javascript" src="../js/param.js"></script>
    <script type="text/javascript" src="../js/district.js"></script>
    <script type="text/javascript">
    var query = $$.parseQueryString();
    var operateType = query.operateType;
    var layer = layui.layer;
    var form = layui.form();
    var element = layui.element();

    function renderImgbox(elem, data) {
        var $item = $(elem).closest('.layui-form-item');
        var $wrap = $item.find('.img-box-wrap');
        if (!$wrap.length) {
            $wrap = $('<div class="layui-input-block img-box-wrap"></div>').appendTo($item);
        }
        var $box = $(template('upload-tpl', data)).data('data', {
            elec_info_type: $(elem).attr('data-type'),
            serverid: data.serverid
        });
        $wrap.html($box);
        $item.find('input[name=serverid]').val(data.serverid); //方便验证

        layer.photos({
            photos: $wrap,
            anim: 5
        });
    }

    function view() {
        $$.request('/action/bm/expense-info/view', query, function(data) {
            $$.loadData('#detail', data.data);


            $.each(data.images, function(index, value) {
                var $elem = $('#detail').find('input[type=file][data-type=' + value.elec_info_type + ']');
                renderImgbox($elem, value);
            });
            form.render();
        });
    }

    function onSubmit(param) {
        // 照片
        var images = [];
        $('#detail').find('.img-box').each(function(index, elem) {
            var data = $(elem).data('data');
            images.push(data);
        });

        param.images = images;

        $$.request('/action/bm/expense-info/' + operateType, param, function(data) {
            $$.info('操作成功', {
                icon: 1
            }, function() {
                onClose();
            });
        });
    }

    function onClose() {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    }


    function initUpload() {
        var index;
        layui.upload({
            url: $$.wrapUrl('/action/upload'),
            before: function(input) {
                index = layer.load(2);
            },
            success: function(res, elem) {
                if (index) layer.close(index);

                if ($$.errcode(res) == 0) {
                    renderImgbox(elem, res);
                } else {
                    $$.info($$.errmsg(res), {
                        icon: 2
                    });
                }
            }
        });
    }

    $(function() {
        if (operateType != 'view') {
            initUpload();
        }

        form.on('submit(detail)', function(data) {
            onSubmit(data.field);
            return false; //阻止表单跳转
        });

        $$.loadSelect('#expense-type', $$.param['expense_type']);
        $$.loadSelect('#expense-cycle', $$.param['expense_cycle']);
        $$.loadSelect('#account-type', $$.param['account_type']);

        form.render('select');        


        $$.transformStatus('#detail', operateType);
        if (query.operateType == 'create') {
            $$.loadData('#detail', query);
            $$.request('/action/bm/mchnt-base-info/view', query, function(data) {
                // data.data.shop_name = data.data.mchnt_abbr;
                $$.loadData('#detail', data.data);
                form.render();
            });
        } else {
            view();
        }
    });
    </script>
</body>

</html>
