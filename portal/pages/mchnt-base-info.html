<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>商户信息</title>
    <link href="../lib/iconfont/iconfont.css" rel="stylesheet">
    <link href="../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="../lib/toastr/toastr.min.css" rel="stylesheet">
    <link href="../lib/easyui/themes/bootstrap/easyui.min.css" rel="stylesheet">
    <style type="text/css">
    .fi {
        font-size: 16px;
        color: #337ab7;
    }
    </style>
</head>

<body>
    <div class="page">
        <form id="ff" data-options="serialize:serializeSearch">
            <table class="table" style="width: 970px;">
                <!-- <caption>查询商户信息</caption> -->
                <tbody>
                    <tr>
                        <td class="text-right col-sm-2">
                            <label>客户号</label>
                        </td>
                        <td class="col-sm-4">
                            <input type="text" name="mchnt_id">
                        </td>
                        <td class="text-right col-sm-2">
                            <label>联系人</label>
                        </td>
                        <td class="col-sm-4">
                            <input type="text" name="linkman">
                        </td>
                    </tr>
                    <!-- <tr>
                        <td class="text-right col-sm-2">
                            <label>手机</label>
                        </td>
                        <td class="col-sm-4">
                            <input type="text" name="mobile">
                        </td>
                        <td class="text-right col-sm-2">
                            <label>商户简称</label>
                        </td>
                        <td class="col-sm-4">
                            <input type="text" name="mchnt_abbr">
                        </td>
                    </tr> -->
                    <tr>
                        <td class="text-right col-sm-2">
                            <label>收单机构</label>
                        </td>
                        <td class="col-sm-4">
                            <select id="acq_inst_id" name="acq_inst_id">
                                <option value="">--请选择--</option>
                            </select>
                        </td>
                        <td class="text-right col-sm-2">
                            <label>商户名称</label>
                        </td>
                        <td class="col-sm-4">
                            <input type="text" name="mchnt_name">
                        </td>
                    </tr>
                    <tr>
                        <td class="text-right col-sm-2">
                            <label>商户号</label>
                        </td>
                        <td class="col-sm-4">
                            <input type="text" name="mchnt_cd">
                        </td>
                        <td class="text-right col-sm-2">
                            <label>终端号</label>
                        </td>
                        <td class="col-sm-4">
                            <input type="text" name="term_id">
                        </td>
                    </tr>
                    <tr>
                        <td class="text-right col-sm-2">
                            <label>所在地区</label>
                        </td>
                        <td class="col-sm-4">
                            <select id="province" name="province" style="width: 98px;">
                                <option value="">--请选择--</option>
                            </select>
                            <select id="city" name="city" style="width: 98px;">
                                <option value="">--请选择--</option>
                            </select>
                            <select id="district" name="district" style="width: 98px;">
                                <option value="">--请选择--</option>
                            </select>
                        </td>
                        <td class="text-right col-sm-2">
                            <label>创建日期</label>
                        </td>
                        <td class="col-sm-4">
                            <input id="created_time" type="text" class="Wdate" name="created_time" style="width: 120px;" onfocus="WdatePicker({onpicked:function(){$dp.$('created_time2').focus();},maxDate:'#F{$dp.$D(\'created_time2\')}'})">
                            <input id="created_time2" type="text" class="Wdate" name="created_time2" style="width: 120px;" onfocus="WdatePicker({minDate:'#F{$dp.$D(\'created_time\')}'})">
                        </td>
                    </tr>
                    <tr>
                        <td class="text-right col-sm-2">
                            <label>处理状态</label>
                        </td>
                        <td class="col-sm-4">
                            <select id="proc_st" name="proc_st">
                                <option value="">--请选择--</option>
                            </select>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td></td>
                        <td colspan="3">
                            <button type="button" class="btn btn-primary" data-options="datagrid:'#dg',url:'/action/bm/mchnt-base-info/search'" onclick="$$.search(this)">查询</button>
                            <button type="button" class="btn btn-default btn-outline" onclick="$$.reset(this)">重置</button>
                            <!-- <button type="button" class="btn btn-success" data-options="datagrid:'#dg',url:'/action/bm/mchnt-base-info/export'" onclick="$$.exportData(this)">导出</button> -->
                        </td>
                    </tr>
                </tfoot>
            </table>
        </form>
        <div id="tb">
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-update" data-options="iconCls:'fi fi-add',plain:true" onclick="$$.open('mchnt-base-info-detail.html?displayType='+displayType+'&operateType=create', '新增商户信息')">新增</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'mchnt-base-info-detail.html?displayType='+displayType+'&operateType=view', '商户信息详情')">详情</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-update tf-update" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'mchnt-base-info-detail.html?displayType='+displayType+'&operateType=update', '编辑商户信息')">编辑</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-update tf-batch-cancel-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/mchnt-base-info/batch-cancel-check1',msg:'取消待审'" onclick="$$.batchSubmit(this)">批量取消待审</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-check1 tf-check1" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'mchnt-base-info-detail.html?displayType='+displayType+'&operateType=check1', '审核商户信息')">审核</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-check1 tf-batch-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/mchnt-base-info/batch-check1-pass',msg:'审核通过'" onclick="$$.batchSubmit(this)">批量审核通过</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-check1 tf-batch-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/mchnt-base-info/batch-check1-nopass',msg:'审核驳回',before:beforeCheck1" onclick="$$.batchSubmit(this)">批量审核驳回</a>
        </div>
        <table id="dg" class="easyui-datagrid" title="商户信息" data-options="singleSelect:true,pagination:true,rownumbers:true,toolbar:'#tb',idField:'rec_id',onClickRow:onClickRow1,onCheck:onCheckRow,onUncheck:onCheckRow,onCheckAll:onCheckRow,onUncheckAll:onCheckRow,collapsible:true">
            <thead>
                <tr>
                    <th data-options="field:'chk',checkbox:true"></th>
                    <th data-options="field:'mchnt_id',width:120">客户号</th>
                    <th data-options="field:'linkman',width:100">联系人</th>
                    <th data-options="field:'mobile',width:100">手机</th>
                    <th data-options="field:'mchnt_abbr',width:200">商户简称</th>
                    <!-- <th data-options="field:'telno',width:100">联系电话</th> -->
                    <!-- <th data-options="field:'district_name',width:150">所在地区</th> -->
                    <th data-options="field:'license_no',width:180">营业执照号</th>
                    <th data-options="field:'expand_inst_nm',width:220">拓展方</th>
                    <th data-options="field:'proc_st_nm',width:100">处理状态</th>
                    <th data-options="field:'created_time',width:150">创建日期</th>
                </tr>
            </thead>
        </table>
        <br>
        <div id="tb2">
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-update" data-options="iconCls:'fi fi-add',plain:true" onclick="onClickAdd2(this)">新增</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'mchnt-param-detail.html?operateType=view', '商户参数详情')">详情</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-update tf-update" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'mchnt-param-detail.html?operateType=update', '编辑商户参数')">编辑</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-update tf-batch-cancel-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/mchnt-param/batch-cancel-check1',msg:'取消待审'" onclick="$$.batchSubmit(this)">批量取消待审</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-check1 tf-check1" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'mchnt-param-detail.html?operateType=check1', '审核商户参数')">审核</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-check1 tf-batch-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/mchnt-param/batch-check1-pass',msg:'审核通过'" onclick="$$.batchSubmit(this)">批量审核通过</a>
            <a href="javascript:void(0)" class="easyui-linkbutton tf tfd-check1 tf-batch-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/mchnt-param/batch-check1-nopass',msg:'审核驳回',before:beforeCheck1" onclick="$$.batchSubmit(this)">批量审核驳回</a>
        </div>
        <table id="dg2" class="easyui-datagrid" title="商户参数" data-options="singleSelect:true,pagination:true,rownumbers:true,toolbar:'#tb2',idField:'rec_id',onClickRow:onClickRow2,onCheck:onCheckRow,onUncheck:onCheckRow,onCheckAll:onCheckRow,onUncheckAll:onCheckRow">
            <thead>
                <tr>
                    <th data-options="field:'chk',checkbox:true"></th>
                    <th data-options="field:'mchnt_id',width:120">客户号</th>
                    <th data-options="field:'busi_type_nm',width:120">业务类型</th>
                    <th data-options="field:'acq_inst_id',width:100">收单机构</th>
                    <th data-options="field:'mchnt_cd',width:100">商户号</th>
                    <th data-options="field:'mchnt_name',width:100">商户名称</th>
                    <th data-options="field:'account_type',width:100,formatter:formatAccountType">账户类型</th>
                    <th data-options="field:'account_name',width:100">开户名称</th>
                    <th data-options="field:'account_name',width:100">开户银行</th>
                    <th data-options="field:'proc_st_nm',width:100">处理状态</th>
                </tr>
            </thead>
        </table>
        <br>
        <div id="tb3">
            <a href="#" class="easyui-linkbutton tf tfd-update" data-options="iconCls:'fi fi-add',plain:true" onclick="onClickAdd3(this)">新增</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'term-info-detail.html?displayType='+displayType+'&operateType=view', '终端信息详情')">详情</a>
            <a href="#" class="easyui-linkbutton tf tfd-update tf-update" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'term-info-detail.html?displayType='+displayType+'&operateType=update', '编辑终端信息')">编辑</a>
            <a href="#" class="easyui-linkbutton tf tfd-update tf-batch-cancel-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/term-info/batch-cancel-check1',msg:'取消待审'" onclick="$$.batchSubmit(this)">批量取消待审</a>
            <a href="#" class="easyui-linkbutton tf tfd-check1 tf-check1" data-options="iconCls:'fi fi-operate',plain:true" onclick="$$.view(this, 'term-info-detail.html?displayType='+displayType+'&operateType=check1', '审核终端信息')">审核</a>
            <a href="#" class="easyui-linkbutton tf tfd-check1 tf-batch-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/term-info/batch-check1-pass',msg:'审核通过'" onclick="$$.batchSubmit(this)">批量审核通过</a>
            <a href="#" class="easyui-linkbutton tf tfd-check1 tf-batch-check1" data-options="iconCls:'fi fi-operate',plain:true,url:'/action/bm/term-info/batch-check1-nopass',msg:'审核驳回',before:beforeCheck1" onclick="$$.batchSubmit(this)">批量审核驳回</a>
        </div>
        <table id="dg3" class="easyui-datagrid" title="终端信息" data-options="singleSelect:true,pagination:true,rownumbers:true,toolbar:'#tb3',idField:'rec_id',onClickRow:onClickRow,onCheck:onCheckRow,onUncheck:onCheckRow,onCheckAll:onCheckRow,onUncheckAll:onCheckRow">
            <thead>
                <tr>
                    <th data-options="field:'chk',checkbox:true"></th>
                    <th data-options="field:'mchnt_id',width:120">客户号</th>
                    <th data-options="field:'term_no',width:120">终端标识</th>
                    <th data-options="field:'linkman',width:100">联系人</th>
                    <th data-options="field:'mobile',width:100">手机号</th>
                    <th data-options="field:'shop_name',width:200">门店名称</th>
                    <th data-options="field:'district_name',width:150">所在地区</th>
                    <th data-options="field:'term_status',width:100,formatter:formatTermStatus">终端状态</th>
                    <th data-options="field:'proc_st_nm',width:100">处理状态</th>
                </tr>
            </thead>
        </table>
    </div>
    <script src="../lib/jquery/jquery.min.js"></script>
    <script src="../lib/toastr/toastr.min.js"></script>
    <script src="../lib/My97DatePicker/WdatePicker.js"></script>
    <script src="../lib/easyui/jquery.easyui.min.js"></script>
    <script src="../js/base.js"></script>
    <script src="../js/st.js"></script>
    <script src="../js/param.js"></script>
    <script src="../js/district.js"></script>
    <script>
    var query = $$.parseQueryString();
    var displayType = query.displayType;
    var operateType = query.operateType;

    function serializeSearch(data) {
        var procStMap = {
            'check1': '1'
        };
        data.proc_st2 = procStMap[displayType];
    }

    function hasNext(oper_in, proc_st, action) {
        var rows = $$.st.transition[$$.st.alias['mchnt_base_info']]
        return $$.hasNextStatus(rows, oper_in, proc_st, action);
    }

    function onClickRow1(rowIndex, rowData) {
        onClickRow.apply(this, arguments);

        var queryParams = {
            mchnt_id: rowData.mchnt_id
        };
        serializeSearch(queryParams);

        $('#dg2').datagrid({
            url: $$.wrapUrl('/action/bm/mchnt-param/search'),
            pageNumber: 1,
            queryParams: queryParams,
            onLoadSuccess: function(data) {
                $(this).datagrid('clearChecked');
                //解决滚动条引起的panel宽度问题
                $(this).datagrid('getPanel').panel('resize');
            },
        });

        $('#dg3').datagrid({
            url: $$.wrapUrl('/action/bm/term-info/search'),
            pageNumber: 1,
            queryParams: queryParams,
            onLoadSuccess: function(data) {
                $(this).datagrid('clearChecked');
                //解决滚动条引起的panel宽度问题
                $(this).datagrid('getPanel').panel('resize');
            },
        });
    }

    function onClickRow2(rowIndex, rowData) {
        onClickRow.apply(this, arguments);

        var queryParams = {
            mchnt_id: rowData.mchnt_id,
            mchnt_param_id: rowData.mchnt_param_id
        };
        serializeSearch(queryParams);

        $('#dg3').datagrid({
            url: $$.wrapUrl('/action/bm/term-info/search'),
            pageNumber: 1,
            queryParams: queryParams,
            onLoadSuccess: function(data) {
                $(this).datagrid('clearChecked');
                //解决滚动条引起的panel宽度问题
                $(this).datagrid('getPanel').panel('resize');
            },
        });
    }


    function onClickRow(rowIndex, rowData) {
        var actionMap = {
            'update': 'update',
            'check1-pass': 'check1'
        };
        var $dg = $(this);
        var $panel = $dg.datagrid('getPanel');
        var $bb = $panel.find('div.datagrid-toolbar').find('.tfd-' + displayType);
        $.each(actionMap, function(action, selector) {
            $bb.filter('.tf-' + selector).addClass('hide');
            if (hasNext(rowData.oper_in, rowData.proc_st, action)) {
                $bb.filter('.tf-' + selector).removeClass('hide');
            }
        });
    }


    function onCheckRow() {
        var actionMap = {
            'cancel-check1': 'batch-cancel-check1',
            'check1-pass': 'batch-check1'
        }
        var $dg = $(this);
        var $panel = $dg.datagrid('getPanel');
        var rows = $dg.datagrid('getChecked');
        var $bb = $panel.find('div.datagrid-toolbar').find('.tfd-' + displayType);
        $.each(actionMap, function(action, selector) {
            var show = true;
            $bb.filter('.tf-' + selector).addClass('hide');

            for (var i = 0; i < rows.length; i++) {
                if (!hasNext(rows[i].oper_in, rows[i].proc_st, action)) {
                    show = false;
                }
            }

            if (show) {
                $bb.filter('.tf-' + selector).removeClass('hide');
            }
        });
    }

    function beforeCheck1(data, callback) {
        var opts = $$.parseOptions(this);
        $$.prompt('请输入' + opts.msg + '原因', function(r) {
            data.checked_reason = r;
            callback();
        });
    }

    function onClickAdd2(target) {
        var selected = $('#dg').datagrid('getSelected');
        if (selected) {
            $$.open('mchnt-param-detail.html?displayType=' + displayType + '&operateType=create&mchnt_id=' + selected.mchnt_id, '新增商户参数');
        } else {
            $$.info('请选择商户信息！');
        }
    }

    function onClickAdd3(target) {
        var selected = $('#dg').datagrid('getSelected');
        if (selected) {
            $$.open('term-info-detail.html?displayType=' + displayType + '&operateType=create&mchnt_id=' + selected.mchnt_id, '新增终端信息');
        } else {
            $$.info('请选择商户信息！');
        }
    }

    function onChangeProvince() {
        var value = $(this).val();
        $$.loadSelect('#city', districtData['city'][value] || []);
        $$.loadSelect('#district', []);
    }

    function onChangeCity() {
        var value = $(this).val();
        $$.loadSelect('#district', districtData['district'][$('#province').val() + value]);
    }

    function formatAccountType(value) {
        return $$.formatField($$.param['account_type'], value);
    }

    function formatTermStatus(value) {
        return $$.formatField($$.param['term_status'], value);
    }

    $(function() {
        $$.transformDisplay('#tb,#tb2,#tb3', displayType);

        $('#ff').on('keyup', function(event) {
            if (event.keyCode == 13) {
                $(this).find('button.btn-primary').click();
            }
        });

        $('#province').on('change', onChangeProvince);
        $('#city').on('change', onChangeCity);

        $$.loadSelect('#province', districtData['province']);

        $$.loadSelect('#proc_st', $$.st.procSt[$$.st.alias['mchnt_base_info']]);

        $$.request('/action/bm/parameter/list', {
            acq_inst: '1'
        }, function(data) {
            $$.loadSelect('#acq_inst_id', data.acq_inst, {
                valueField: 'acq_inst_id',
                textField: 'acq_inst_nm'
            });
        });
    });
    </script>
</body>

</html>