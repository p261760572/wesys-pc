<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>费用信息</title>
    <link rel="stylesheet" type="text/css" href="../lib/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="../lib/select2/css/select2.min.css">
    <link rel="stylesheet" type="text/css" href="../css/base.css">
</head>

<body>
    <form id="detail" class="layui-form" action="" method="post" data-options="load:loadDetail,serialize:serializeDetail">
        <input type="hidden" name="mchnt_expense_id"> 费用单据号
        <input type="text" name="expense_no"> 客户号
        <input type="text" name="mchnt_id" > 商户简称
        <input type="text" name="mchnt_abbr"> 商户名称
        <input type="text" name="mchnt_name"> 费用类型
        <select name="expense_type"  lay-filter="expense_type" id="expense-type">
            <option value=""></option>
        </select>
        金额
        <input type="text" name="amount" > 收费周期
        <select name="expense_cycle"  id="expense-cycle">
            <option value=""></option>
        </select>
        收费开始时间
        <input type="text" name="start_date"   class="layui-input Wdate" onfocus="WdatePicker({onpicked:function(){$dp.$('end_date').focus();},maxDate:'#F{$dp.$D(\'end_date\')}'})" id="start_date"> 收费结束时间
        <input type="text" name="end_date"   class="layui-input Wdate" onfocus="WdatePicker({minDate:'#F{$dp.$D(\'start_date\')}'})" id="end_date"> 领用人
        <select name="recipient_by"  lay-search id="recipient-by">
            <option value=""></option>
        </select>
        备注
        <input type="text" name="remark">
 发票号
        <input type="text" name="invoice_no"> 收款方式
        <select name="receipt_type"  id="receipt-type">
            <option value=""></option>
        </select>
        收款日期
        <input type="text" name="receipt_date"    class="layui-input Wdate" onfocus="WdatePicker()"> 收款备注
        <input type="text" name="receipt_remark"> 收款人
        <input type="text" name="receipt_by"> 收款时间
        <input type="text" name="receipt_time"> 作废备注
        <input type="text" name="cancel_remark"> 作废人
        <input type="text" name="cancel_by"> 作废时间
        <input type="text" name="cancel_time"> 退款原因
        <select name="refund_reason_flag"  id="refund-reason-flag">
            <option value=""></option>
        </select>
        退款方式
        <select name="refund_type"  id="refund-type">
            <option value=""></option>
        </select>
        退款金额
        <input type="text" name="refund_amount" > 退款开户名称
        <input type="text" name="refund_account_name" > 退款开户银行
        <select name="refund_account_bank"  lay-search id="refund-account-bank">
            <option value=""></option>
        </select>
        退款开户支行
        <select name="refund_account_bank_branch_cd" style="width: 100%;"  lay-ignore id="refund-account-bank-branch-cd">
            <option value=""></option>
        </select>
        <!-- 
                    退款开户支行
                    
                        <select name="refund_account_bank_branch_cd" style="width: 100%;"  lay-ignore id="refund-account-bank-branch-cd">
                            <option value=""></option>
                        </select>
                    
                 -->
        退款银行账号
        <input type="text" name="refund_account_no" > 可退付日期
        <input type="text" name="refund_date"   class="layui-input Wdate" onfocus="WdatePicker()"> 退款备注
        <input type="text" name="refund_remark"> 退款人
        <input type="text" name="refund_by"> 退款时间
        <input type="text" name="refund_time"> 打印标志
        <input type="text" name="print_flag"> 打印人
        <input type="text" name="print_by"> 打印时间
        <input type="text" name="print_time">
        <!-- 
                    验证随机数
                    
                        <input type="text" name="rand_num">
                    
                 -->
        记录编号
        <input type="text" name="rec_id"> 处理状态
        <input type="text" name="oper_in">
        <input type="text" name="proc_st"> 创建人
        <input type="text" name="created_by"> 创建时间
        <input type="text" name="created_time"> 最后修改人
        <input type="text" name="last_modified_by"> 最后修改时间
        <input type="text" name="last_modified_time">
        <!-- 
                
                    最后审核人
                    
                        <input type="text" name="last_checked_by">
                    
                
                
                    最后审核时间
                    
                        <input type="text" name="last_checked_time">
                    
                
            
            
                审核备注
                
                    <input type="text" name="checked_reason">
                
             -->
        <button type="button" class="layui-btn visible invisible-view" onclick="$$.submit(this)" data-options="url:'/action/bm/expense-info/' + operateType">提交</button>
        <button type="button" class="layui-btn layui-btn-primary" onclick="$$.close()">关闭</button>
    </form>
    <script id="upload-tpl" type="text/html">
    </script>
    <script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/layui/lay/dest/layui.all.js"></script>
    <script type="text/javascript" src="../lib/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript" src="../lib/select2/js/select2.min.js"></script>
    <script type="text/javascript" src="../js/template.js"></script>
    <script type="text/javascript" src="../js/base.js"></script>
    <script type="text/javascript" src="../js/param.js"></script>
    <script type="text/javascript" src="../js/district.js"></script>
    <script type="text/javascript">
    var query = $$.parseQueryString();
    var operateType = query.operateType;
    var form = layui.form();
    var element = layui.element();


    function loadDetail(data) {
        $('#refund-amount-total').text(parseFloat(data.data.refund_amount_total || 0).toFixed(2));

        if (data.data.refund_account_bank_branch_cd) {
            $('#refund-account-bank-branch-cd').html('<option value="' + data.data.refund_account_bank_branch_cd + '">' + data.data.bank_branch_nm + '</option>').trigger('change');
        }
    }

    function serializeDetail(data) {
        data.expense_cycle = $('#expense-cycle').val();
    }

    function formatDate(value) {
        return value ? value.substr(0, 10) : value;
    }

    function onChangeExpenseType() {
        var value = $(this).val();
        if (value == '1' || value == '4') {
            $('#expense-cycle').val('1').attr('disabled', 'disabled');
        } else {
            $('#expense-cycle').removeAttr('disabled');
        }
        form.render('select');
    }

    $(function() {
        $('#expense-type').on('change', onChangeExpenseType);

        form.on('select(expense_type)', function(data) {
            $(data.elem).change();
        });

        $$.loadSelect('#expense-type', $$.param['expense_type']);
        $$.loadSelect('#expense-cycle', $$.param['expense_cycle']);
        $$.loadSelect('#receipt-type', $$.param['receipt_type']);
        $$.loadSelect('#refund-reason-flag', $$.param['refund_reason_flag']);
        $$.loadSelect('#refund-type', $$.param['refund_type']);

        $('#refund-account-bank-branch-cd').select2({
            language: 'zh-CN',
            placeholder: '请选择',
            ajax: {
                url: $$.wrapUrl('/action/bm/bank-branch/search'),
                type: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    console.log(arguments);
                    return $.toJSON({
                        q: params.term,
                        bank_cd: $('#refund-account-bank').val(),
                        page: params.page,
                        size: 20
                    });
                },
                processResults: function(data, params) {
                    console.log(arguments);
                    params.page = params.page || 1;

                    if ($$.errcode(data) == 0) {
                        for (var i = 0; i < data.rows.length; i++) {
                            data.rows[i].id = data.rows[i].bank_branch_cd;
                            data.rows[i].text = data.rows[i].bank_branch_nm;
                        }
                        return {
                            results: data.rows,
                            pagination: {
                                more: (params.page * 20) < data.total
                            }
                        };
                    }

                    return {};
                },
                cache: true
            },
            minimumInputLength: 1
        });

        var d1 = $$.request('/action/bm/recipient/list', {}, function(data) {
            $$.loadSelect('#recipient-by', data.rows);
            form.render('select');
        });

        var d2 = $$.request('/action/bm/parameter/list', {
            bank: '1'
        }, function(data) {
            $$.loadSelect('#refund-account-bank', data.bank, {
                valueField: 'bank_cd',
                textField: 'bank_nm'
            });
            form.render('select');
        });

        form.render();

        $$.transformStatus('#detail', operateType);
        $.when(d1, d2).done(function() {
            if (query.operateType == 'create') {
                $$.loadData('#detail', query);
                $$.request('/action/bm/mchnt-expense/view', query, function(data) {
                    data.data.start_date = formatDate(data.data.start_date);
                    data.data.end_date = formatDate(data.data.end_date);

                    $$.loadData('#detail', data.data);
                    form.render();
                });
            } else {
                $$.view('#detail', '/action/bm/expense-info/view', query);
            }
        });
    });
    </script>
</body>

</html>
